<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beer Coaster Gallery</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; color: #222; }
    header { background: #222; color: white; padding: 1rem; text-align: center; }
    .filters { padding: 1rem; text-align: center; }
    .letters button { margin: 0.2rem; padding: 0.5rem 0.8rem; cursor: pointer; border: none; background: #eee; border-radius: 4px; }
    .letters button.active { background: #333; color: white; font-weight: bold; }
    #countryFilter { padding: 0.5rem; margin-left: 1rem; }

    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 1rem; }
    .gallery img { width: 100%; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .lightbox { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 999; }
    .lightbox img { max-width: 90%; max-height: 80vh; }
    .lightbox-controls { margin-top: 1rem; display: flex; gap: 1rem; }
    .lightbox button { padding: 0.5rem 1rem; }
  </style>
</head>
<body>
  <header>
    <h1>Beer Coaster Gallery</h1>
    <p>Total coasters: <span id="count">0</span></p>
  </header>

  <div class="filters">
    <div class="letters"></div>
    <label>
      Country:
      <select id="countryFilter"></select>
    </label>
  </div>

  <div class="gallery" id="gallery"></div>

  <div class="lightbox" id="lightbox">
    <img id="lightbox-img" src="" alt="coaster full"/>
    <div class="lightbox-controls">
      <button onclick="toggleSide()">Flip</button>
      <button onclick="closeLightbox()">Close</button>
    </div>
  </div>

  <script>
    let metadata = [];
    let activeAlpha = 'all';
    let activeCountry = 'all';
    let currentSide = 'front';

    function initFilters(data) {
      const alphaDiv = document.querySelector('.letters');
      alphaDiv.innerHTML = '';

      ['All', ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), 'Empty'].forEach(letter => {
        const btn = document.createElement('button');
        btn.textContent = letter;
        btn.dataset.letter = letter;
        if (letter.toLowerCase() === 'all') btn.classList.add('active');
        btn.onclick = () => {
          activeAlpha = letter.toLowerCase();
          document.querySelectorAll('.letters button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderGallery();
        };
        alphaDiv.append(btn);
      });

      const countries = ['All', ...new Set(data.map(m => m.country || 'Empty'))];
      const countrySelect = document.getElementById('countryFilter');
      countrySelect.innerHTML = '';
      countries.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.toLowerCase();
        opt.textContent = c;
        countrySelect.appendChild(opt);
      });
      countrySelect.onchange = e => {
        activeCountry = e.target.value;
        renderGallery();
      };
    }

    function renderGallery() {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';

      const filtered = metadata.filter(m => {
        const matchAlpha = activeAlpha === 'all' || 
                           (activeAlpha === 'empty' && !(m.description || '').trim()) ||
                           (m.description || '').toLowerCase().startsWith(activeAlpha);
        const matchCountry = activeCountry === 'all' || 
                             (activeCountry === 'empty' && !(m.country || '').trim()) ||
                             (m.country || '').toLowerCase() === activeCountry;
        return matchAlpha && matchCountry;
      });

      document.getElementById('count').textContent = filtered.length;

      filtered.forEach(m => {
        const img = document.createElement('img');
        img.src = `images/thumbs/${m.id}_front.webp`;
        img.alt = m.description || m.id;
        img.onclick = () => openLightbox(m.id);
        gallery.appendChild(img);
      });
    }

    function openLightbox(id) {
      currentSide = 'front';
      const imgEl = document.getElementById('lightbox-img');
      imgEl.src = `images/${id}_${currentSide}.webp`;
      imgEl.dataset.id = id;
      document.getElementById('lightbox').style.display = 'flex';
    }

    function closeLightbox() {
      document.getElementById('lightbox').style.display = 'none';
    }

    function toggleSide() {
      const imgEl = document.getElementById('lightbox-img');
      currentSide = currentSide === 'front' ? 'back' : 'front';
      imgEl.src = `images/${imgEl.dataset.id}_${currentSide}.webp`;
    }

    fetch('./metadata.json')
      .then(res => res.ok ? res.json() : Promise.reject('Failed to fetch metadata.json'))
      .then(data => {
        metadata = data;
        initFilters(data);
        renderGallery();
      })
      .catch(err => {
        console.error(err);
        alert("Failed to load metadata.");
      });
  </script>
</body>
</html>
